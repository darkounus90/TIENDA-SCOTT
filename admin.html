<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - El Pedalazo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css?v=4.2.1">
    <style>
        /* Specific overrides for standalone admin page */
        body {
            margin: 0;
            padding: 0;
            background: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }

        .admin-dashboard-container {
            display: grid;
            grid-template-columns: 260px 1fr;
            height: 100vh;
            width: 100vw;
        }

        .admin-main {
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .admin-content-area {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }
    </style>
</head>

<body>

    <div class="admin-dashboard-container" id="adminApp" style="display:none;">
        <!-- Sidebar -->
        <aside class="admin-sidebar" style="height: 100vh;">
            <div class="admin-sidebar-header">
                <h2>üöÄ SCOTT Admin</h2>
            </div>
            <nav class="admin-nav">
                <button class="admin-tab-btn active" data-tab="tab-overview">
                    <span class="icon">üìä</span> <span>Resumen</span>
                </button>
                <button class="admin-tab-btn" data-tab="tab-orders">
                    <span class="icon">üõçÔ∏è</span> <span>Ventas</span>
                </button>
                <button class="admin-tab-btn" data-tab="tab-inventory">
                    <span class="icon">üö≤</span> <span>Inventario</span>
                </button>
                <button class="admin-tab-btn" data-tab="tab-users">
                    <span class="icon">üë•</span> <span>Usuarios</span>
                </button>
                <button class="admin-tab-btn" id="adminLogout">
                    <span class="icon">üö™</span> <span>Salir</span>
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-topbar">
                <h3>Panel de Control</h3>
                <div style="display:flex; gap:1rem; align-items:center;">
                    <span id="adminUsername" style="font-weight:600; color:#475569;">Admin</span>
                    <a href="/" class="btn-secondary" style="text-decoration:none; padding: 0.5rem 1rem;">Ir a
                        Tienda</a>
                </div>
            </div>

            <div class="admin-content-area">
                <!-- Tab: Overview -->
                <div id="tab-overview" class="view-section active">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-info">
                                <h4>Ventas Totales</h4>
                                <p id="statTotalSales">$0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üì¶</div>
                            <div class="stat-info">
                                <h4>Pedidos Hoy</h4>
                                <p id="statOrdersToday">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üö≤</div>
                            <div class="stat-info">
                                <h4>Productos</h4>
                                <p id="statTotalProducts">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-info">
                                <h4>Usuarios</h4>
                                <p id="statTotalUsers">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="table-card">
                        <div class="table-header">
                            <h3>√öltimos Pedidos</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Usuario</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrdersTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Orders -->
                <div id="tab-orders" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Historial de Ventas</h3>
                            <input type="text" placeholder="Buscar..."
                                style="padding:0.5rem; border-radius:8px; border:1px solid #cbd5e1;">
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Referencia</th>
                                    <th>Cliente</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="allOrdersTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Inventory -->
                <div id="tab-inventory" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Inventario</h3>
                            <button class="btn-primary" onclick="openAddProduct()">+ Producto</button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Img</th>
                                    <th>Producto</th>
                                    <th>Stock</th>
                                    <th>Precio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Users -->
                <div id="tab-users" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Usuarios</h3>
                        </div>
                        <div style="padding:2rem;text-align:center;">Pr√≥ximamente</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Add Product (Reused) -->
    <div class="cart-modal" id="addProductModal">
        <div class="cart-modal__content add-product-modal">
            <button class="cart-modal__close" id="closeAddProduct">‚úï</button>
            <h2>Agregar Nuevo Producto</h2>
            <form id="addProductForm" class="product-form">
                <!-- Shortened for brevity, JS handles population if needed or just copy full structure -->
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Precio</label>
                        <input type="number" name="price" required>
                    </div>
                    <!-- Add full fields later visually or reusing CSS -->
                </div>
                <button type="submit" class="btn-primary">Guardar</button>
            </form>
        </div>
    </div>

    <script>
        // ADMIN LOGIC ISOLATED
        const API_BASE = 'api';

        async function checkAdmin() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert("No hay token de sesi√≥n. Inicia sesi√≥n nuevamente.");
                window.location.href = 'index.html';
                return;
            }

            try {
                // Check against API with Bearer prefix
                const res = await fetch(`${API_BASE}/me.php`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`Error del servidor: ${res.status}`);
                }

                const data = await res.json();

                if (data.success && data.user.isAdmin) {
                    document.getElementById('adminApp').style.display = 'grid';
                    document.getElementById('adminUsername').textContent = data.user.username;
                    loadDashboard();
                } else {
                    console.warn("Acceso denegado:", data);
                    alert("Acceso denegado: No tienes permisos de administrador o tu sesi√≥n ha expirado.");
                    window.location.href = 'index.html';
                }
            } catch (e) {
                console.error("Admin check error:", e);
                alert("Error al verificar credenciales: " + e.message);
                window.location.href = 'index.html';
            }
        }

        document.getElementById('adminLogout').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        });

        // Tab Logic
        document.querySelectorAll('.admin-tab-btn[data-tab]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        async function loadDashboard() {
            // Fetch data similar to app.js
            const token = localStorage.getItem('token');
            // Fetch Orders
            const res = await fetch(`${API_BASE}/orders.php`, { headers: { 'Authorization': token } });
            const data = await res.json();
            if (data.success) {
                renderOrders(data.orders);
                renderStats(data.orders);
            }

            // Fetch Products
            const prodRes = await fetch(`${API_BASE}/products.php`);
            const products = await prodRes.json();
            renderInventory(products);
            document.getElementById('statTotalProducts').textContent = products.length;
        }

        function renderStats(orders) {
            const total = orders.filter(o => o.status !== 'cancelled').reduce((acc, o) => acc + Number(o.total), 0);
            document.getElementById('statTotalSales').innerText = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(total);
            document.getElementById('statOrdersToday').innerText = orders.filter(o => o.created_at.startsWith(new Date().toISOString().split('T')[0])).length;
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('allOrdersTable');
            tbody.innerHTML = orders.map(o => `
        <tr>
            <td>${o.id}</td>
            <td>${o.reference || '-'}</td>
            <td>${o.user_name}</td>
            <td>${o.items.length}</td>
            <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(o.total)}</td>
            <td>${o.status}</td>
            <td><button>Ver</button></td>
        </tr>
    `).join('');

            // Recent
            document.getElementById('recentOrdersTable').innerHTML = orders.slice(0, 5).map(o => `
        <tr>
            <td>${o.reference}</td>
            <td>${o.user_name}</td>
            <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(o.total)}</td>
            <td>${o.status}</td>
            <td>${o.created_at}</td>
        </tr>
    `).join('');
        }

        function renderInventory(products) {
            document.getElementById('inventoryTable').innerHTML = products.map(p => `
        <tr>
            <td><img src="${p.image || p.images[0]}" width="30"></td>
            <td>${p.name}</td>
            <td>${p.stock}</td>
            <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(p.price)}</td>
            <td><button>‚úèÔ∏è</button></td>
        </tr>
    `).join('');
        }

        checkAdmin();
    </script>
</body>

</html>