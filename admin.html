<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - El Pedalazo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css?v=4.6.0">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <!-- SheetJS for Excel Import -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* Specific overrides for standalone admin page */
        body {
            margin: 0;
            padding: 0;
            background: var(--bg-deep);
            /* Use theme variable */
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        .admin-dashboard-container {
            display: grid;
            grid-template-columns: 260px 1fr;
            height: 100vh;
            width: 100vw;
        }

        .admin-sidebar {
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
        }

        .admin-sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .admin-sidebar-header h2 {
            font-size: 1.5rem;
            background: linear-gradient(to right, var(--accent), var(--primary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .admin-nav {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .admin-tab-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 1rem;
            text-align: left;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1rem;
        }

        .admin-tab-btn:hover,
        .admin-tab-btn.active {
            background: var(--glass-bg);
            color: var(--text-main);
            border: 1px solid var(--glass-border);
        }

        .admin-tab-btn.active {
            background: var(--primary-glow);
            /* Fallback */
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.1), transparent);
            border-left: 3px solid var(--primary);
        }

        .admin-main {
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .admin-topbar {
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(3, 0, 20, 0.5);
        }

        .admin-content-area {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        /* Stats Cards */
        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .stat-icon {
            font-size: 2rem;
            background: rgba(255, 255, 255, 0.05);
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .table-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            color: var(--text-muted);
        }

        .data-table th {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-main);
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        /* FIX: Hide overlay globally so it doesn't break Desktop Grid */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* Hamburger Menu Button (Hidden on Desktop) */
        .mobile-menu-toggle {
            display: none;
            background: transparent;
            border: none;
            color: var(--text-main);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 1rem;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Table Responsive Wrapper */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* MOBILE RESPONSIVE STYLES */
        @media (max-width: 768px) {

            /* Show hamburger menu */
            .mobile-menu-toggle {
                display: block;
            }

            /* Change container to single column */
            .admin-dashboard-container {
                grid-template-columns: 1fr;
            }

            /* Sidebar: Fixed overlay on mobile */
            .admin-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 260px;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                border-right: 1px solid var(--glass-border);
                background: rgba(15, 23, 42, 0.98);
            }

            /* Show sidebar when active */
            .admin-sidebar.active {
                transform: translateX(0);
            }

            /* Overlay backdrop */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .sidebar-overlay.active {
                display: block;
            }

            /* Adjust topbar */
            .admin-topbar {
                padding: 1rem;
            }

            .admin-topbar h3 {
                font-size: 1.1rem;
            }

            /* Stats grid: 1 column on mobile */
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            /* Content area padding */
            .admin-content-area {
                padding: 1rem;
            }

            /* Table cards */
            .table-card {
                padding: 1rem;
                margin-top: 1rem;
            }

            /* Make tables scrollable */
            .data-table {
                font-size: 0.85rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.75rem 0.5rem;
                white-space: nowrap;
            }

            /* Form adjustments in modals */
            .cart-modal__content,
            .add-product-modal {
                max-width: 95vw;
                padding: 1.5rem;
                max-height: 90vh;
                overflow-y: auto;
            }

            .form-grid {
                grid-template-columns: 1fr !important;
            }

            /* Hide some columns on very small screens */
            @media (max-width: 480px) {
                .dashboard-grid {
                    grid-template-columns: 1fr;
                }
            }
        }
    </style>
</head>

<body>

    <div class="admin-dashboard-container" id="adminApp" style="display:none;">
        <!-- Mobile Overlay (for closing sidebar) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="admin-sidebar" id="adminSidebar" style="height: 100vh;">
            <div class="admin-sidebar-header" style="text-align: center; padding: 1.5rem 1rem;">
                <img src="logo-pedalazo-completo.svg" alt="Admin Logo"
                    style="height: 60px; display: block; margin: 0 auto 0.5rem auto;">
            </div>
            <nav class="admin-nav">
                <a href="#overview" class="admin-tab-btn active" data-tab="tab-overview">
                    <span class="icon">üìä</span> <span>Resumen</span>
                </a>
                <a href="#orders" class="admin-tab-btn" data-tab="tab-orders">
                    <span class="icon">üõçÔ∏è</span> <span>Ventas</span>
                </a>
                <a href="#inventory" class="admin-tab-btn" data-tab="tab-inventory">
                    <span class="icon">üö≤</span> <span>Inventario</span>
                </a>
                <a href="#services" class="admin-tab-btn" data-tab="tab-services">
                    <span class="icon">üõ†Ô∏è</span> <span>Taller</span>
                </a>
                <a href="#users" class="admin-tab-btn" data-tab="tab-users">
                    <span class="icon">üë•</span> <span>Usuarios</span>
                </a>
                <button class="admin-tab-btn" id="adminLogout">
                    <span class="icon">üö™</span> <span>Salir</span>
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-topbar">
                <div style="display:flex; align-items:center; gap:1rem;">
                    <button class="mobile-menu-toggle" id="mobileMenuToggle">‚ò∞</button>
                    <h3>Panel de Control</h3>
                </div>
                <div style="display:flex; gap:1rem; align-items:center;">
                    <span id="adminUsername" style="font-weight:600; color:#475569;">Admin</span>
                    <a href="/" class="btn-secondary" style="text-decoration:none; padding: 0.5rem 1rem;">Ir a
                        Tienda</a>
                </div>
            </div>

            <div class="admin-content-area">
                <!-- Tab: Overview -->
                <div id="tab-overview" class="view-section active">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-info">
                                <h4>Ventas Totales</h4>
                                <p id="statTotalSales">$0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üì¶</div>
                            <div class="stat-info">
                                <h4>Pedidos Hoy</h4>
                                <p id="statOrdersToday">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üö≤</div>
                            <div class="stat-info">
                                <h4>Productos</h4>
                                <p id="statTotalProducts">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-info">
                                <h4>Usuarios</h4>
                                <p id="statTotalUsers">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="table-card">
                        <div class="table-header">
                            <h3>√öltimos Pedidos</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Usuario</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrdersTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Orders -->
                <div id="tab-orders" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Historial de Ventas</h3>
                            <input type="text" placeholder="Buscar..."
                                style="padding:0.5rem; border-radius:8px; border:1px solid #cbd5e1;">
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Referencia</th>
                                    <th>Cliente</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="allOrdersTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Inventory -->
                <div id="tab-inventory" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Inventario</h3>
                            <div style="display:flex; gap:10px;">
                                <input type="file" id="excelInput" accept=".xlsx, .xls" style="display:none;"
                                    onchange="handleExcelUpload(this)">
                                <button class="btn-secondary" onclick="document.getElementById('excelInput').click()">üì•
                                    Importar Excel</button>
                                <button class="btn-primary" onclick="openAddProduct()">+ Producto</button>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Img</th>
                                    <th>Producto</th>
                                    <th>Stock</th>
                                    <th>Precio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Taller / Services -->
                <div id="tab-services" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Servicios Taller</h3>
                            <button class="btn-primary" onclick="openAddService()">+ Nuevo Servicio</button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Cliente</th>
                                    <th>Bicicleta</th>
                                    <th>Servicio</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="servicesTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Users -->

                <div id="tab-users" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Usuarios Registrados</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Usuario</th>
                                    <th>Email</th>
                                    <th>Tel√©fono</th>
                                    <th>Rol</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modal Add Product Full -->
    <div class="cart-modal" id="addProductModal" onclick="closeAddProduct()">
        <div class="cart-modal__content add-product-modal" onclick="event.stopPropagation()">
            <button class="cart-modal__close" onclick="closeAddProduct()">‚úï</button>
            <h2>Agregar Nuevo Producto</h2>
            <form id="addProductForm" class="product-form" onsubmit="submitProduct(event)">
                <div class="form-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre del Producto</label>
                            <input type="text" name="name" required class="form-input" placeholder="Ej: Scott Spark RC">
                        </div>
                        <div class="form-group">
                            <label>Marca</label>
                            <input type="text" name="brand" required class="form-input" placeholder="Ej: Scott"
                                list="brandsList" autocomplete="off">
                            <datalist id="brandsList"></datalist>
                        </div>
                        <div class="form-group">
                            <label>Categor√≠a</label>
                            <input type="text" name="category" required class="form-input"
                                placeholder="Selecciona o escribe nueva..." list="categoriesList" autocomplete="off">
                            <datalist id="categoriesList"></datalist>
                        </div>
                        <div class="form-group">
                            <label>Precio</label>
                            <input type="number" name="price" required class="form-input" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Stock</label>
                            <input type="number" name="stock" required class="form-input" placeholder="1">
                        </div>
                        <div class="form-group">
                            <label>Uso</label>
                            <input type="text" name="use" required class="form-input" placeholder="Ej: Monta√±a, Ruta">
                        </div>
                        <div class="form-group">
                            <label>Etiqueta</label>
                            <input type="text" name="tag" class="form-input" placeholder="Ej: Nuevo">
                        </div>
                        <div class="form-group">
                            <label>C√≥digo de Barras</label>
                            <input type="text" name="barcode" class="form-input" placeholder="Opcional">
                        </div>
                    </div>

                    <div class="form-group full-width" style="margin-top: 1.5rem;">
                        <label>Im√°genes del Producto</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="productImages" multiple accept="image/*"
                                onchange="handleImagePreview(this)" class="file-input">
                            <div class="file-cta">
                                <span class="icon">üì∑</span>
                                <span>Seleccionar im√°genes (M√°x 3)</span>
                            </div>
                        </div>
                        <div id="imagePreviewGrid" class="image-preview-grid"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddProduct()">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Add Service -->
    <div class="cart-modal" id="addServiceModal" onclick="closeAddService()">
        <div class="cart-modal__content add-product-modal" onclick="event.stopPropagation()">
            <button class="cart-modal__close" onclick="closeAddService()">‚úï</button>
            <h2>Registrar Servicio Taller</h2>
            <form id="addServiceForm" class="product-form" onsubmit="submitService(event)">
                <div class="form-body">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Usuario (ID de Cliente)</label>
                            <div style="display:flex; gap:10px;">
                                <input type="number" name="user_id" id="serviceUserId" required class="form-input"
                                    placeholder="ID de usuario">
                                <!-- Podr√≠amos a√±adir b√∫squeda aqu√≠ luego -->
                            </div>
                            <small style="color:#666;">Ingresa el ID del usuario registrado.</small>
                        </div>
                        <div class="form-group">
                            <label>Bicicleta</label>
                            <input type="text" name="bike" required class="form-input" placeholder="Ej: Scott Spark RC">
                        </div>
                        <div class="form-group">
                            <label>Tipo Servicio</label>
                            <select name="type" required class="form-input">
                                <option value="Mantenimiento General">Mantenimiento General</option>
                                <option value="Ajuste Frenos">Ajuste Frenos</option>
                                <option value="Ajuste Cambios">Ajuste Cambios</option>
                                <option value="Lavado Especial">Lavado Especial</option>
                                <option value="Suspensi√≥n">Suspensi√≥n</option>
                                <option value="Garant√≠a">Garant√≠a</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label>Descripci√≥n / Notas</label>
                            <textarea name="description" class="form-input" rows="3"
                                placeholder="Detalles del trabajo..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Estado</label>
                            <select name="status" class="form-input">
                                <option value="recibido">Recibido</option>
                                <option value="en_proceso">En Proceso</option>
                                <option value="listo">Listo</option>
                                <option value="entregado">Entregado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Costo Estimado</label>
                            <input type="number" name="cost" class="form-input" placeholder="0">
                        </div>
                    </div>

                    <div class="form-group full-width" style="margin-top: 1.5rem;">
                        <label>Fotos del Proceso</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="serviceImages" multiple accept="image/*"
                                onchange="handleServiceImagePreview(this)" class="file-input">
                            <div class="file-cta">
                                <span class="icon">üì∑</span>
                                <span>Subir Fotos</span>
                            </div>
                        </div>
                        <div id="serviceImagePreviewGrid" class="image-preview-grid"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddService()">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Registro</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ADMIN LOGIC ISOLATED
        const API_BASE = 'api';

        // --- Product Management ---
        function openAddProduct() {
            const modal = document.getElementById('addProductModal');
            modal.classList.add('active');
            modal.classList.add('cart-modal--open'); // Asegurar consistencia con CSS
            loadProductMetadata();
        }



        async function loadProductMetadata() {
            try {
                const res = await fetch(`${API_BASE}/products.php?action=metadata`);
                const data = await res.json();

                if (data.success) {
                    // Brands
                    const bList = document.getElementById('brandsList');
                    const bInput = document.querySelector('input[name="brand"]');
                    if (bList && data.brands) {
                        bList.innerHTML = data.brands.map(b => `<option value="${b}">`).join('');
                    }

                    // Categories
                    const cList = document.getElementById('categoriesList');
                    const cInput = document.querySelector('input[name="category"]');
                    if (cList && data.categories) {
                        // Add default/common categories if empty or just mix them
                        const defaults = ['Bicicletas', 'Accesorios', 'Repuestos', 'Ropa', 'Cascos', 'Zapatillas'];
                        const allCats = [...new Set([...defaults, ...data.categories])];
                        cList.innerHTML = allCats.map(c => `<option value="${c}">`).join('');
                    }
                }
            } catch (e) { console.error("Error loading metadata", e); }
        }


        function closeAddProduct() {
            const modal = document.getElementById('addProductModal');
            modal.classList.remove('active');
            modal.classList.remove('cart-modal--open');
            document.getElementById('addProductForm').reset();
            document.getElementById('imagePreviewGrid').innerHTML = '';
            productImagesBase64 = [];
        }

        let productImagesBase64 = [];

        async function handleImagePreview(input) {
            const files = Array.from(input.files).slice(0, 3);
            const grid = document.getElementById('imagePreviewGrid');
            grid.innerHTML = '';
            productImagesBase64 = [];

            for (const file of files) {
                const base64 = await toBase64(file);
                productImagesBase64.push(base64);

                const img = document.createElement('img');
                img.src = base64;
                img.style.width = '80px';
                img.style.height = '80px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '4px';
                grid.appendChild(img);
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // --- EXCEL IMPORT LOGIC ---
        async function handleExcelUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (!confirm(`¬øDeseas importar productos desde "${file.name}"?`)) {
                input.value = ''; // Reset
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.SheetNames[0];
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet]);

                    if (rows.length === 0) {
                        alert("El archivo Excel parece vac√≠o.");
                        return;
                    }

                    let successCount = 0;
                    let errorCount = 0;
                    const token = localStorage.getItem('token');

                    // Show visual feedback
                    const btn = document.querySelector('.btn-secondary[onclick*="excelInput"]');
                    const originalText = btn.innerText;
                    btn.innerText = "‚è≥ Procesando...";
                    btn.disabled = true;

                    for (const row of rows) {
                        // Flexible Mapping
                        const priceRaw = row['Precio'] || row['Price'] || row['Valor'] || row['Costo'] || 0;
                        const stockRaw = row['Stock'] || row['Cantidad'] || row['Unidades'] || 0;

                        // Clean data
                        const payload = {
                            name: row['Nombre'] || row['Producto'] || row['Name'] || row['Item'],
                            brand: row['Marca'] || row['Brand'] || 'Gen√©rico',
                            category: row['Categoria'] || row['Categor√≠a'] || row['Category'] || 'General',
                            price: parseFloat(String(priceRaw).replace(/[^0-9.]/g, '')),
                            stock: parseInt(String(stockRaw).replace(/[^0-9]/g, '')) || 0,
                            use: row['Uso'] || row['Use'] || 'General',
                            tag: row['Etiqueta'] || row['Tag'] || '',
                            barcode: row['Codigo'] || row['C√≥digo'] || row['Barcode'] || '',
                            images: [] // No images from Excel usually unless URL
                        };

                        if (!payload.name) continue; // Skip empty rows

                        try {
                            const res = await fetch(`${API_BASE}/products.php`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify(payload)
                            });
                            const json = await res.json();
                            if (json.success) successCount++;
                            else errorCount++;
                        } catch (err) {
                            errorCount++;
                            console.error("Error importando fila:", row, err);
                        }
                    }

                    alert(`Importaci√≥n completada:\n‚úÖ ${successCount} productos creados.\n‚ùå ${errorCount} errores.`);
                    loadDashboard(); // Refresh inventory

                    // Reset UI
                    btn.innerText = originalText;
                    btn.disabled = false;
                    input.value = '';

                } catch (err) {
                    console.error("Error parsing Excel:", err);
                    alert("Error al leer el archivo Excel. Aseg√∫rate de que sea v√°lido.");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function submitProduct(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            const payload = {
                name: formData.get('name'),
                brand: formData.get('brand'),
                category: formData.get('category'),
                price: parseFloat(formData.get('price')),
                stock: parseInt(formData.get('stock')),
                use: formData.get('use'),
                tag: formData.get('tag'),
                barcode: formData.get('barcode'),
                images: productImagesBase64
            };

            const token = localStorage.getItem('token');

            try {
                const res = await fetch(`${API_BASE}/products.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (data.success) {
                    alert('Producto creado exitosamente');
                    closeAddProduct();
                    loadDashboard(); // Recargar inventario
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (err) {
                console.error(err);
                alert('Error de conexi√≥n');
            }
        }

        async function checkAdmin() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert("No hay token de sesi√≥n. Inicia sesi√≥n nuevamente.");
                window.location.href = 'index.html';
                return;
            }

            try {
                // Check against API with Bearer prefix AND query param backup + Cache Buster
                const res = await fetch(`${API_BASE}/me.php?token=${encodeURIComponent(token)}&_t=${Date.now()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`Error del servidor (${res.status}). Intenta recargar.`);
                }

                const data = await res.json();

                if (data.success && data.user.isAdmin) {
                    document.getElementById('adminApp').style.display = 'grid';
                    document.getElementById('adminUsername').textContent = data.user.username;
                    loadDashboard();
                } else {
                    // Solo redirigir si la API dice expl√≠citamente que no es v√°lido
                    console.warn("Acceso denegado:", data);
                    alert("Sesi√≥n cerrada por el servidor:\n" + (data.message || "Token inv√°lido/caducado"));
                    localStorage.removeItem('token'); // Limpiar token inv√°lido
                    window.location.href = 'index.html';
                }
            } catch (e) {
                console.error("Admin check error:", e);
                // Si es error de conexi√≥n o parseo, NO redirigir autom√°ticamente, dar opci√≥n al usuario
                const retry = confirm("Error de conexi√≥n con el servidor:\n" + e.message + "\n\n¬øDeseas reintentar?");
                if (retry) {
                    location.reload();
                } else {
                    // Opcional: Ir al inicio si el usuario desiste
                    // window.location.href = 'index.html';
                }
            }
        }

        document.getElementById('adminLogout').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        });

        // Tab Logic
        // ROUTING LOGIC (Hash-based)
        const tabsMap = {
            '': 'tab-overview',
            '#overview': 'tab-overview',
            '#orders': 'tab-orders',
            '#inventory': 'tab-inventory',
            '#services': 'tab-services',
            '#users': 'tab-users'
        };

        function handleHashChange() {
            const hash = window.location.hash || '#overview';
            const targetId = tabsMap[hash] || 'tab-overview';

            // Remove active classes
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));

            // Add active classes
            const activeBtn = document.querySelector(`.admin-tab-btn[href="${hash}"]`) ||
                document.querySelector(`.admin-tab-btn[href="#overview"]`);
            if (activeBtn) activeBtn.classList.add('active');

            const activeSection = document.getElementById(targetId);
            if (activeSection) activeSection.classList.add('active');
        }

        // Initialize Routing
        window.addEventListener('hashchange', handleHashChange);
        window.addEventListener('load', handleHashChange);

        // Mobile Menu Toggle
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const adminSidebar = document.getElementById('adminSidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        // Open sidebar
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', () => {
                adminSidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
            });
        }

        // Close sidebar when clicking overlay
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                adminSidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });
        }

        // Close sidebar when clicking a menu link (mobile)
        document.querySelectorAll('.admin-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    adminSidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                }
            });
        });


        async function loadDashboard() {
            // Fetch data similar to app.js
            const token = localStorage.getItem('token');
            // Fetch Orders
            const res = await fetch(`${API_BASE}/orders.php`, { headers: { 'Authorization': token } });
            const data = await res.json();
            if (data.success) {
                renderOrders(data.orders);
                renderStats(data.orders);
            }


            // Fetch Products
            const prodRes = await fetch(`${API_BASE}/products.php`);
            const prodData = await prodRes.json();
            if (prodData.success) {
                renderInventory(prodData.products);
                document.getElementById('statTotalProducts').textContent = prodData.products.length;
            }

            // Fetch Users
            try {
                const uRes = await fetch(`${API_BASE}/api_admin.php?action=users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const uData = await uRes.json();
                if (uData.success) {
                    renderUsers(uData.users);
                    document.getElementById('statTotalUsers').textContent = uData.users.length;
                }
            } catch (e) { console.error("Error loading users", e); }

            // Fetch Services
            loadServices();

        }

        // --- SERVICES LOGIC ---
        function openAddService() {
            document.getElementById('addServiceModal').classList.add('active');
            document.getElementById('addServiceModal').classList.add('cart-modal--open');
        }
        function closeAddService() {
            const m = document.getElementById('addServiceModal');
            m.classList.remove('active');
            m.classList.remove('cart-modal--open');
            document.getElementById('addServiceForm').reset();
            document.getElementById('serviceImagePreviewGrid').innerHTML = '';
            serviceImagesBase64 = [];
        }

        let serviceImagesBase64 = [];
        async function handleServiceImagePreview(input) {
            const files = Array.from(input.files).slice(0, 5);
            const grid = document.getElementById('serviceImagePreviewGrid');
            grid.innerHTML = '';
            serviceImagesBase64 = [];
            for (const file of files) {
                const base64 = await toBase64(file);
                serviceImagesBase64.push(base64);
                const img = document.createElement('img');
                img.src = base64;
                img.style.width = '80px'; img.style.height = '80px';
                img.style.objectFit = 'cover'; img.style.borderRadius = '4px';
                grid.appendChild(img);
            }
        }

        async function submitService(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const payload = {
                user_id: formData.get('user_id'),
                bike: formData.get('bike'),
                type: formData.get('type'),
                description: formData.get('description'),
                status: formData.get('status'),
                cost: formData.get('cost'),
                images: serviceImagesBase64
            };

            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_BASE}/services.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.success) {
                    alert('Servicio registrado');
                    closeAddService();
                    loadServices();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (ex) { console.error(ex); alert('Error de conexi√≥n'); }
        }

        async function loadServices() {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_BASE}/services.php`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    renderServicesTB(data.services);
                }
            } catch (e) {
                console.error("Error loading services", e);
            }
        }

        function renderServicesTB(services) {
            const tbody = document.getElementById('servicesTableBody');
            if (!tbody) return;
            tbody.innerHTML = services.map(s => `
    <tr>
        <td>${s.id}</td>
        <td>${s.username} <br><small>${s.email}</small></td>
        <td>${s.bike_model}</td>
        <td>${s.service_type}</td>
        <td>
            <select onchange="updateServiceStatus(${s.id}, this.value)"
                style="padding:4px; border-radius:4px; border:1px solid #ddd; bg:${getStatusColor(s.status)}">
                <option value="recibido" ${s.status == 'recibido' ? 'selected' : ''}>Recibido</option>
                <option value="en_proceso" ${s.status == 'en_proceso' ? 'selected' : ''}>En Proceso</option>
                <option value="listo" ${s.status == 'listo' ? 'selected' : ''}>Listo</option>
                <option value="entregado" ${s.status == 'entregado' ? 'selected' : ''}>Entregado</option>
            </select>
        </td>
        <td>${new Date(s.entry_date).toLocaleDateString()}</td>
        <td><button onclick="alert('Ver detalles no implementado en admin a√∫n')">üëÅÔ∏è</button></td>
    </tr>
    `).join('');
        }

        async function updateServiceStatus(id, newStatus) {
            const token = localStorage.getItem('token');
            try {
                await fetch(`${API_BASE}/services.php`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ id: id, status: newStatus })
                });
                // alert('Estado actualizado');
            } catch (e) { alert('Error actualizando estado'); }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'listo': return '#d1fae5';
                case 'en_proceso': return '#dbeafe';
                case 'entregado': return '#f3f4f6';
                default: return '#fff';
            }
        }

        function renderStats(orders) {
            const total = orders.filter(o => o.status !== 'cancelled').reduce((acc, o) => acc + Number(o.total), 0);
            document.getElementById('statTotalSales').innerText = new Intl.NumberFormat('es-CO', {
                style: 'currency', currency:
                    'COP'
            }).format(total);
            document.getElementById('statOrdersToday').innerText = orders.filter(o => o.created_at.startsWith(new
                Date().toISOString().split('T')[0])).length;
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('allOrdersTable');
            tbody.innerHTML = orders.map(o => `
    <tr>
        <td>${o.id}</td>
        <td>${o.reference || '-'}</td>
        <td>${o.user_name}</td>
        <td>${o.items.length}</td>
        <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(o.total)}</td>
        <td>${o.status}</td>
        <td><button>Ver</button></td>
    </tr>
    `).join('');

            // Recent
            document.getElementById('recentOrdersTable').innerHTML = orders.slice(0, 5).map(o => `
    <tr>
        <td>${o.reference}</td>
        <td>${o.user_name}</td>
        <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(o.total)}</td>
        <td>${o.status}</td>
        <td>${o.created_at}</td>
    </tr>
    `).join('');
        }


        function renderInventory(products) {
            document.getElementById('inventoryTable').innerHTML = products.map(p => `
    <tr>
        <td><img src="${p.image || p.images[0]}" width="30"></td>
        <td>${p.name}</td>
        <td>${p.stock}</td>
        <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(p.price)}</td>
        <td><button>‚úèÔ∏è</button></td>
    </tr>
    `).join('');
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            tbody.innerHTML = users.map(u => `
    <tr>
        <td>${u.id}</td>
        <td>${u.username}</td>
        <td>${u.email}</td>
        <td>${u.phone || '-'}</td>
        <td>
            <select onchange="changeRole(${u.id}, this.value)"
                style="padding:0.2rem; border-radius:4px; border:1px solid #ccc;">
                <option value="0" ${u.isAdmin == 0 ? 'selected' : ''}>Usuario</option>
                <option value="1" ${u.isAdmin == 1 ? 'selected' : ''}>Admin</option>
            </select>
        </td>
    </tr>
    `).join('');
        }

        async function changeRole(id, val) {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_BASE}/update_role.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ id: id, isAdmin: val })
                });
                const data = await res.json();
                alert(data.message);
                // Reload dashboard to reflect changes if necessary
            } catch (e) {
                console.error(e);
                alert("Error al actualizar rol");
            }
        }

        checkAdmin();
    </script>
</body>

</html>