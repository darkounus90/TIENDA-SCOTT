<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - El Pedalazo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css?v=14.4.0">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <!-- SheetJS y ChartJS -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Sobrescrituras espec√≠ficas para p√°gina de admin independiente */
        body {
            margin: 0;
            padding: 0;
            background: var(--bg-deep);
            /* Usar variable de tema */
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        .admin-dashboard-container {
            display: grid;
            grid-template-columns: 260px 1fr;
            height: 100vh;
            width: 100vw;
        }

        .admin-sidebar {
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
        }

        .admin-sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .admin-sidebar-header h2 {
            font-size: 1.5rem;
            background: linear-gradient(to right, var(--accent), var(--primary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .admin-nav {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .admin-tab-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            padding: 1rem;
            text-align: left;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1rem;
        }

        .admin-tab-btn:hover,
        .admin-tab-btn.active {
            background: var(--glass-bg);
            color: var(--text-main);
            border: 1px solid var(--glass-border);
        }

        .admin-tab-btn.active {
            background: var(--primary-glow);
            /* Respaldo */
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.1), transparent);
            border-left: 3px solid var(--primary);
        }

        .admin-main {
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .admin-topbar {
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(3, 0, 20, 0.5);
        }

        .admin-content-area {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        /* Tarjetas de Estad√≠sticas */
        .stat-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .stat-icon {
            font-size: 2rem;
            background: rgba(255, 255, 255, 0.05);
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .table-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            color: var(--text-muted);
        }

        .data-table th {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-main);
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
        }

        /* ARREGLO: Ocultar superposici√≥n globalmente para no romper Cuadr√≠cula de Escritorio */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* Bot√≥n de Men√∫ Hamburguesa (Oculto en Escritorio) */
        .mobile-menu-toggle {
            display: none;
            background: transparent;
            border: none;
            color: var(--text-main);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 1rem;
        }

        /* Cuadr√≠cula del Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Envoltorio Responsivo de Tabla */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* ESTILOS RESPONSIVOS M√ìVILES */
        @media (max-width: 768px) {

            /* Mostrar men√∫ hamburguesa */
            .mobile-menu-toggle {
                display: block;
            }

            /* Cambiar contenedor a una sola columna */
            .admin-dashboard-container {
                grid-template-columns: 1fr;
            }

            /* Barra lateral: Superposici√≥n fija en m√≥vil */
            .admin-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 260px;
                z-index: 1000;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                border-right: 1px solid var(--glass-border);
                background: rgba(15, 23, 42, 0.98);
            }

            /* Mostrar barra lateral cuando est√° activa */
            .admin-sidebar.active {
                transform: translateX(0);
            }

            /* Fondo de superposici√≥n */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .sidebar-overlay.active {
                display: block;
            }

            /* Ajustar barra superior */
            .admin-topbar {
                padding: 1rem;
            }

            .admin-topbar h3 {
                font-size: 1.1rem;
            }

            /* Cuadr√≠cula de estad√≠sticas: 1 columna en m√≥vil */
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            /* Relleno del √°rea de contenido */
            .admin-content-area {
                padding: 1rem;
            }

            /* Tarjetas de tabla */
            .table-card {
                padding: 1rem;
                margin-top: 1rem;
            }

            /* Hacer tablas desplazables */
            .data-table {
                font-size: 0.85rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.75rem 0.5rem;
                white-space: nowrap;
            }

            /* Ajustes de formulario en modales */
            .cart-modal__content,
            .add-product-modal {
                max-width: 95vw;
                padding: 1.5rem;
                max-height: 90vh;
                overflow-y: auto;
            }

            .form-grid {
                grid-template-columns: 1fr !important;
            }

            /* Ocultar algunas columnas en pantallas muy peque√±as */
            @media (max-width: 480px) {
                .dashboard-grid {
                    grid-template-columns: 1fr;
                }
            }
        }
    </style>
</head>

<body>

    <div class="admin-dashboard-container" id="adminApp" style="display:none;">
        <!-- Superposici√≥n M√≥vil (para cerrar barra lateral) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Barra Lateral -->
        <aside class="admin-sidebar" id="adminSidebar" style="height: 100vh;">
            <div class="admin-sidebar-header"
                style="text-align: center; padding: 1rem; display: flex; align-items: center; justify-content: center;">
                <img src="logo-pedalazo-icon.svg" alt="Admin Logo" style="height: 45px; width: auto;">
                <span
                    style="font-size: 1.6rem; font-weight: 800; color: white; -webkit-text-fill-color: white; margin-left: -8px; letter-spacing: -1px; font-family: 'Inter', sans-serif;">edalazo</span>
            </div>
            <nav class="admin-nav">
                <a href="#overview" class="admin-tab-btn active" data-tab="tab-overview">
                    <span class="icon">üìä</span> <span>Resumen</span>
                </a>
                <a href="#orders" class="admin-tab-btn" data-tab="tab-orders">
                    <span class="icon">üõçÔ∏è</span> <span>Ventas</span>
                </a>
                <a href="#inventory" class="admin-tab-btn" data-tab="tab-inventory">
                    <span class="icon">üö≤</span> <span>Inventario</span>
                </a>
                <a href="#services" class="admin-tab-btn" data-tab="tab-services">
                    <span class="icon">üõ†Ô∏è</span> <span>Taller</span>
                </a>
                <a href="#users" class="admin-tab-btn" data-tab="tab-users">
                    <span class="icon">üë•</span> <span>Usuarios</span>
                </a>
                <button class="admin-tab-btn" id="adminLogout">
                    <span class="icon">üö™</span> <span>Salir</span>
                </button>
            </nav>
        </aside>

        <!-- Contenido Principal -->
        <main class="admin-main">
            <div class="admin-topbar">
                <div style="display:flex; align-items:center; gap:1rem;">
                    <button class="mobile-menu-toggle" id="mobileMenuToggle">‚ò∞</button>
                    <h3>Panel de Control</h3>
                </div>
                <div style="display:flex; gap:1rem; align-items:center;">
                    <span id="adminUsername" style="font-weight:600; color:#475569;">Admin</span>
                    <a href="/" class="btn-secondary" style="text-decoration:none; padding: 0.5rem 1rem;">Ir a
                        Tienda</a>
                </div>
            </div>

            <div class="admin-content-area">
                <!-- Pesta√±a: Resumen -->
                <div id="tab-overview" class="view-section active">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-info">
                                <h4>Ventas Totales</h4>
                                <p id="statTotalSales">$0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üì¶</div>
                            <div class="stat-info">
                                <h4>Pedidos Hoy</h4>
                                <p id="statOrdersToday">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üö≤</div>
                            <div class="stat-info">
                                <h4>Productos</h4>
                                <p id="statTotalProducts">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-info">
                                <h4>Usuarios</h4>
                                <p id="statTotalUsers">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="table-card" style="margin-top: 2rem;">
                        <div class="table-header">
                            <h3>Evoluci√≥n de Ventas</h3>
                        </div>
                        <div style="height: 300px; width: 100%; position: relative;">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>

                    <div class="table-card">
                        <div class="table-header">
                            <h3>√öltimos Pedidos</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Usuario</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrdersTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Pesta√±a: Pedidos -->
                <div id="tab-orders" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Historial de Ventas</h3>
                            <input type="text" placeholder="Buscar..."
                                style="padding:0.5rem; border-radius:8px; border:1px solid #cbd5e1;">
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Referencia</th>
                                    <th>Cliente</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="allOrdersTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Pesta√±a: Inventario -->
                <div id="tab-inventory" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Inventario</h3>
                            <div style="display:flex; gap:10px;">
                                <input type="file" id="excelInput" accept=".xlsx, .xls" style="display:none;"
                                    onchange="handleExcelUpload(this)">
                                <button class="btn-secondary" onclick="document.getElementById('excelInput').click()">üì•
                                    Importar Excel</button>
                                <button class="btn-secondary" onclick="exportInventoryToExcel()">üì§
                                    Exportar Excel</button>
                                <button class="btn-primary" onclick="openAddProduct()">+ Producto</button>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Img</th>
                                    <th>Producto</th>
                                    <th>Stock</th>
                                    <th>Precio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Pesta√±a: Taller / Servicios -->
                <div id="tab-services" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Servicios Taller</h3>
                            <button class="btn-primary" onclick="openAddService()">+ Nuevo Servicio</button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Cliente</th>
                                    <th>Bicicleta</th>
                                    <th>Servicio</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="servicesTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Pesta√±a: Usuarios -->

                <div id="tab-users" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Usuarios Registrados</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Usuario</th>
                                    <th>Email</th>
                                    <th>Tel√©fono</th>
                                    <th>Rol</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modal Agregar Producto Completo -->
    <div class="cart-modal" id="addProductModal" onclick="closeAddProduct()">
        <div class="cart-modal__content add-product-modal" onclick="event.stopPropagation()">
            <button class="cart-modal__close" onclick="closeAddProduct()">‚úï</button>
            <h2>Agregar Nuevo Producto</h2>
            <form id="addProductForm" class="product-form" onsubmit="submitProduct(event)">
                <div class="form-body">
                    <input type="hidden" id="editProductId" value="">
                    <div class="form-grid">
                        <div class="form-group full-width"
                            style="margin-bottom: 1rem; background: rgba(59, 130, 246, 0.05); padding: 1rem; border-radius: 8px; border: 1px dashed var(--glass-border);">
                            <label style="margin-bottom: 0.5rem; display: block; font-weight: 600;">Tipo de
                                Producto:</label>
                            <div style="display: flex; gap: 2rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="productType" value="bike" checked
                                        onchange="toggleProductType('bike')">
                                    üö≤ Bicicleta / Ciclismo
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="productType" value="car"
                                        onchange="toggleProductType('car')">
                                    üöó Automotriz / Repuesto
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Nombre del Producto</label>
                            <input type="text" name="name" required class="form-input" placeholder="Ej: Scott Spark RC">
                        </div>
                        <div class="form-group">
                            <label>Marca</label>
                            <div class="hybrid-field" id="wrap-brand">
                                <div class="mode-select" style="display:flex; gap:0.5rem;">
                                    <select id="brandSelect" class="form-input"
                                        onchange="setFinalValue('brand', this.value)">
                                        <option value="">Selecciona...</option>
                                    </select>
                                    <button type="button" class="btn-hybrid-toggle"
                                        onclick="toggleHybrid('brand', 'input')" title="Nueva Marca">
                                        ‚ûï
                                    </button>
                                </div>
                                <div class="mode-input" style="display:none; gap:0.5rem;">
                                    <input type="text" id="brandInput" class="form-input"
                                        placeholder="Escribe nueva marca..."
                                        oninput="setFinalValue('brand', this.value)">
                                    <button type="button" class="btn-hybrid-toggle"
                                        onclick="toggleHybrid('brand', 'select')" title="Volver a lista">
                                        üìã
                                    </button>
                                </div>
                                <input type="hidden" name="brand" id="final-brand">
                                <div class="hybrid-help"
                                    style="display:none; color: var(--primary-glow); font-size: 0.8rem; margin-top: 0.4rem;">
                                    ‚ú® Se guardar√° autom√°ticamente al crear el producto.
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Categor√≠a</label>
                            <div class="hybrid-field" id="wrap-category">
                                <div class="mode-select" style="display:flex; gap:0.5rem;">
                                    <select id="categorySelect" class="form-input"
                                        onchange="setFinalValue('category', this.value)">
                                        <option value="">Selecciona...</option>
                                    </select>
                                    <button type="button" class="btn-hybrid-toggle"
                                        onclick="toggleHybrid('category', 'input')" title="Nueva Categor√≠a">
                                        ‚ûï
                                    </button>
                                </div>
                                <div class="mode-input" style="display:none; gap:0.5rem;">
                                    <input type="text" id="categoryInput" class="form-input"
                                        placeholder="Escribe nueva categor√≠a..."
                                        oninput="setFinalValue('category', this.value)">
                                    <button type="button" class="btn-hybrid-toggle"
                                        onclick="toggleHybrid('category', 'select')" title="Volver a lista">
                                        üìã
                                    </button>
                                </div>
                                <input type="hidden" name="category" id="final-category">
                                <div class="hybrid-help"
                                    style="display:none; color: var(--primary-glow); font-size: 0.8rem; margin-top: 0.4rem;">
                                    ‚ú® Se guardar√° autom√°ticamente al crear el producto.
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Precio</label>
                            <input type="number" name="price" required class="form-input" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label>Stock</label>
                            <input type="number" name="stock" required class="form-input" placeholder="1">
                        </div>
                        <div class="form-group">
                            <label id="lbl-use">Uso / Modelo (Referencia)</label>
                            <!-- Hidden input captures the final value -->
                            <input type="hidden" name="use" id="final-use">

                            <!-- Mode: Text Input (Default/Bikes) -->
                            <input type="text" id="input-use" class="form-input" placeholder="Ej: Monta√±a, Ruta"
                                oninput="document.getElementById('final-use').value = this.value">

                            <!-- Mode: Select (Cars) -->
                            <select id="select-use" class="form-input" style="display:none;"
                                onchange="document.getElementById('final-use').value = this.value; document.getElementById('input-use').value = this.value;">
                                <option value="">Selecciona Modelo...</option>
                            </select>
                        </div>
                        <div class="form-group" id="group-model-year" style="display:none;">
                            <label>Modelo (A√±os Compatibles)</label>
                            <input type="text" id="input-model-year" class="form-input" placeholder="Ej: 2015-2023">
                        </div>

                        <div class="form-group">
                            <label>Etiqueta / Estado</label>
                            <input type="text" name="tag" id="input-tag" class="form-input"
                                placeholder="Ej: Nuevo, Oferta">
                        </div>
                        <div class="form-group">
                            <label>C√≥digo de Barras</label>
                            <input type="text" name="barcode" class="form-input" placeholder="Opcional">
                        </div>
                    </div>

                    <div class="form-group full-width" style="margin-top: 1.5rem;">
                        <label>Im√°genes del Producto</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="productImages" multiple accept="image/*"
                                onchange="handleImagePreview(this)" class="file-input">
                            <div class="file-cta">
                                <span class="icon">üì∑</span>
                                <span>Seleccionar im√°genes (M√°x 3)</span>
                            </div>
                        </div>
                        <div id="imagePreviewGrid" class="image-preview-grid"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddProduct()">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Agregar Servicio -->
    <div class="cart-modal" id="addServiceModal" onclick="closeAddService()">
        <div class="cart-modal__content add-product-modal" onclick="event.stopPropagation()">
            <button class="cart-modal__close" onclick="closeAddService()">‚úï</button>
            <h2>Registrar Servicio Taller</h2>
            <form id="addServiceForm" class="product-form" onsubmit="submitService(event)">
                <div class="form-body">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Usuario (ID de Cliente)</label>
                            <div style="display:flex; gap:10px;">
                                <input type="number" name="user_id" id="serviceUserId" required class="form-input"
                                    placeholder="ID de usuario">
                                <!-- Podr√≠amos a√±adir b√∫squeda aqu√≠ luego -->
                            </div>
                            <small style="color:#666;">Ingresa el ID del usuario registrado.</small>
                        </div>
                        <div class="form-group">
                            <label>Bicicleta</label>
                            <input type="text" name="bike" required class="form-input" placeholder="Ej: Scott Spark RC">
                        </div>
                        <div class="form-group">
                            <label>Tipo Servicio</label>
                            <select name="type" required class="form-input">
                                <option value="Mantenimiento General">Mantenimiento General</option>
                                <option value="Ajuste Frenos">Ajuste Frenos</option>
                                <option value="Ajuste Cambios">Ajuste Cambios</option>
                                <option value="Lavado Especial">Lavado Especial</option>
                                <option value="Suspensi√≥n">Suspensi√≥n</option>
                                <option value="Garant√≠a">Garant√≠a</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label>Descripci√≥n / Notas</label>
                            <textarea name="description" class="form-input" rows="3"
                                placeholder="Detalles del trabajo..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Estado</label>
                            <select name="status" class="form-input">
                                <option value="recibido">Recibido</option>
                                <option value="en_proceso">En Proceso</option>
                                <option value="listo">Listo</option>
                                <option value="entregado">Entregado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Costo Estimado</label>
                            <input type="number" name="cost" class="form-input" placeholder="0">
                        </div>
                    </div>

                    <div class="form-group full-width" style="margin-top: 1.5rem;">
                        <label>Fotos del Proceso</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="serviceImages" multiple accept="image/*"
                                onchange="handleServiceImagePreview(this)" class="file-input">
                            <div class="file-cta">
                                <span class="icon">üì∑</span>
                                <span>Subir Fotos</span>
                            </div>
                        </div>
                        <div id="serviceImagePreviewGrid" class="image-preview-grid"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddService()">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar Registro</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // L√ìGICA DE ADMIN AISLADA
        const API_BASE = 'api';

        // --- Gesti√≥n de Productos ---
        function openAddProduct() {
            const modal = document.getElementById('addProductModal');
            modal.classList.add('active');
            modal.classList.add('cart-modal--open'); // Asegurar consistencia con CSS
            loadProductMetadata();
        }

        function toggleHybrid(type, mode) {
            const wrap = document.getElementById(`wrap-${type}`);
            if (!wrap) return;
            const selMode = wrap.querySelector('.mode-select');
            const inpMode = wrap.querySelector('.mode-input');
            const hidden = document.getElementById(`final-${type}`);
            const help = wrap.querySelector('.hybrid-help');

            if (mode === 'input') {
                selMode.style.display = 'none';
                inpMode.style.display = 'flex';
                const inp = document.getElementById(`${type}Input`);
                if (inp) {
                    inp.value = '';
                    inp.focus();
                }
                if (hidden) hidden.value = '';
                if (help) help.style.display = 'block';
            } else {
                inpMode.style.display = 'none';
                selMode.style.display = 'flex';
                const sel = document.getElementById(`${type}Select`);
                if (sel) sel.value = '';
                if (hidden) hidden.value = '';
                if (help) help.style.display = 'none';
            }
        }

        function setFinalValue(type, val) {
            const field = document.getElementById(`final-${type}`);
            if (field) field.value = val;
        }

        async function loadProductMetadata() {
            try {
                const res = await fetch(`${API_BASE}/products.php?action=metadata`);
                const data = await res.json();

                if (data.success) {
                    // Brands
                    const bSel = document.getElementById('brandSelect');
                    if (bSel && data.brands) {
                        bSel.innerHTML = '<option value="">Selecciona Marca...</option>' +
                            data.brands.map(b => `<option value="${b}">${b}</option>`).join('');
                    }

                    // Categories
                    const cSel = document.getElementById('categorySelect');
                    if (cSel && data.categories) {
                        const defaults = [
                            // Bicicletas - Clasificaci√≥n detallada
                            'MTB', 'Ruta', 'Gravel', 'Ciudad', 'E-Bikes',
                            // General Ciclismo
                            'Accesorios', 'Repuestos', 'Ropa', 'Cascos', 'Zapatillas',
                            // Automotriz - Clasificaci√≥n comercial Colombia
                            'Chevrolet (Spark/Sail/Onix)', 'Renault (Logan/Sandero/Duster)',
                            'Kia (Picanto/Rio)', 'Mazda (2/3/CX)', 'Nissan', 'Toyota', 'Hyundai', 'Taxis'
                        ];
                        const allCats = [...new Set([...defaults, ...data.categories])].sort();
                        cSel.innerHTML = '<option value="">Selecciona Categor√≠a...</option>' +
                            allCats.map(c => `<option value="${c}">${c}</option>`).join('');
                    }
                }
            } catch (e) { console.error("Error loading Metadata", e); }
        }

        function closeAddProduct() {
            const modal = document.getElementById('addProductModal');
            modal.classList.remove('active');
            modal.classList.remove('cart-modal--open');
            document.getElementById('addProductForm').reset();
            // Reiniciar Campos H√≠bridos
            toggleHybrid('brand', 'select');
            toggleHybrid('category', 'select');

            document.getElementById('imagePreviewGrid').innerHTML = '';
            productImagesBase64 = [];
        }

        let productImagesBase64 = [];

        async function handleImagePreview(input) {
            const files = Array.from(input.files).slice(0, 3);
            const grid = document.getElementById('imagePreviewGrid');
            grid.innerHTML = '';
            productImagesBase64 = [];

            for (const file of files) {
                const base64 = await toBase64(file);
                productImagesBase64.push(base64);

                const img = document.createElement('img');
                img.src = base64;
                img.style.width = '80px';
                img.style.height = '80px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '4px';
                grid.appendChild(img);
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // --- L√ìGICA DE IMPORTACI√ìN EXCEL ---
        async function handleExcelUpload(input) {
            const file = input.files[0];
            if (!file) return;

            if (!confirm(`¬øDeseas importar productos desde "${file.name}"?`)) {
                input.value = ''; // Reset
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.SheetNames[0];
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet]);

                    if (rows.length === 0) {
                        alert("El archivo Excel parece vac√≠o.");
                        return;
                    }

                    let successCount = 0;
                    let errorCount = 0;
                    const token = localStorage.getItem('token');

                    // Mostrar retroalimentaci√≥n visual
                    const btn = document.querySelector('.btn-secondary[onclick*="excelInput"]');
                    const originalText = btn.innerText;
                    btn.innerText = "‚è≥ Procesando...";
                    btn.disabled = true;

                    for (const row of rows) {
                        // Mapeo Flexible
                        const priceRaw = row['Precio'] || row['Price'] || row['Valor'] || row['Costo'] || 0;
                        const stockRaw = row['Stock'] || row['Cantidad'] || row['Unidades'] || 0;

                        // Limpiar datos
                        const payload = {
                            name: row['Nombre'] || row['Producto'] || row['Name'] || row['Item'],
                            brand: row['Marca'] || row['Brand'] || 'Gen√©rico',
                            category: row['Categoria'] || row['Categor√≠a'] || row['Category'] || 'General',
                            price: parseFloat(String(priceRaw).replace(/[^0-9.]/g, '')),
                            stock: parseInt(String(stockRaw).replace(/[^0-9]/g, '')) || 0,
                            use: row['Uso'] || row['Use'] || 'General',
                            tag: row['Etiqueta'] || row['Tag'] || '',
                            barcode: row['Codigo'] || row['C√≥digo'] || row['Barcode'] || '',
                            images: [] // Usualmente sin im√°genes de Excel a menos que sea URL
                        };

                        if (!payload.name) continue; // Saltar filas vac√≠as

                        try {
                            const res = await fetch(`${API_BASE}/products.php`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify(payload)
                            });
                            const json = await res.json();
                            if (json.success) successCount++;
                            else errorCount++;
                        } catch (err) {
                            errorCount++;
                            console.error("Error importando fila:", row, err);
                        }
                    }

                    alert(`Importaci√≥n completada:\n‚úÖ ${successCount} productos creados.\n‚ùå ${errorCount} errores.`);
                    loadDashboard(); // Refrescar inventario

                    // Reiniciar UI
                    btn.innerText = originalText;
                    btn.disabled = false;
                    input.value = '';

                } catch (err) {
                    console.error("Error parsing Excel:", err);
                    alert("Error al leer el archivo Excel. Aseg√∫rate de que sea v√°lido.");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function submitProduct(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            // Handle Model Year for Cars
            let tag = formData.get('tag') || '';
            const modelYear = document.getElementById('input-model-year')?.value;
            // Only append if visible
            if (modelYear && document.getElementById('group-model-year')?.style.display !== 'none') {
                tag = tag ? `${tag} | ${modelYear}` : modelYear;
            }

            const payload = {
                name: formData.get('name'),
                brand: formData.get('brand'),
                category: formData.get('category'),
                price: parseFloat(formData.get('price')),
                stock: parseInt(formData.get('stock')),
                use: formData.get('use'),
                tag: tag,
                barcode: formData.get('barcode'),
                images: productImagesBase64
            };

            const editId = document.getElementById('editProductId').value;
            if (editId) {
                payload.id = editId;
            }

            const token = localStorage.getItem('token');

            try {
                const res = await fetch(`${API_BASE}/products.php`, {
                    method: editId ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (data.success) {
                    alert('Producto guardado exitosamente');
                    closeAddProduct();
                    loadDashboard(); // Recargar inventario
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (err) {
                console.error(err);
                alert('Error de conexi√≥n');
            }
        }

        async function checkAdmin() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert("No hay token de sesi√≥n. Inicia sesi√≥n nuevamente.");
                window.location.href = 'index.html';
                return;
            }

            try {
                // Verificar contra API con prefijo Bearer Y respaldo de par√°metro de consulta + Cache Buster
                const res = await fetch(`${API_BASE}/me.php?token=${encodeURIComponent(token)}&_t=${Date.now()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`Error del servidor (${res.status}). Intenta recargar.`);
                }

                const data = await res.json();

                if (data.success && data.user.isAdmin) {
                    document.getElementById('adminApp').style.display = 'grid';
                    document.getElementById('adminUsername').textContent = data.user.username;
                    loadDashboard();
                } else {
                    // Solo redirigir si la API dice expl√≠citamente que no es v√°lido
                    console.warn("Acceso denegado:", data);
                    alert("Sesi√≥n cerrada por el servidor:\n" + (data.message || "Token inv√°lido/caducado"));
                    localStorage.removeItem('token'); // Limpiar token inv√°lido
                    window.location.href = 'index.html';
                }
            } catch (e) {
                console.error("Admin check error:", e);
                // Si es error de conexi√≥n o parseo, NO redirigir autom√°ticamente, dar opci√≥n al usuario
                const retry = confirm("Error de conexi√≥n con el servidor:\n" + e.message + "\n\n¬øDeseas reintentar?");
                if (retry) {
                    location.reload();
                } else {
                    // Opcional: Ir al inicio si el usuario desiste
                    // window.location.href = 'index.html';
                }
            }
        }

        document.getElementById('adminLogout').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        });

        // L√≥gica de Pesta√±as
        // L√ìGICA DE ENRUTAMIENTO (Basada en Hash)
        const tabsMap = {
            '': 'tab-overview',
            '#overview': 'tab-overview',
            '#orders': 'tab-orders',
            '#inventory': 'tab-inventory',
            '#services': 'tab-services',
            '#users': 'tab-users'
        };

        function handleHashChange() {
            const hash = window.location.hash || '#overview';
            const targetId = tabsMap[hash] || 'tab-overview';

            // Eliminar clases activas
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));

            // A√±adir clases activas
            const activeBtn = document.querySelector(`.admin-tab-btn[href="${hash}"]`) ||
                document.querySelector(`.admin-tab-btn[href="#overview"]`);
            if (activeBtn) activeBtn.classList.add('active');

            const activeSection = document.getElementById(targetId);
            if (activeSection) activeSection.classList.add('active');
        }

        // Inicializar Enrutamiento
        window.addEventListener('hashchange', handleHashChange);
        window.addEventListener('load', handleHashChange);

        // Alternar Men√∫ M√≥vil
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const adminSidebar = document.getElementById('adminSidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        // Abrir barra lateral
        if (mobileMenuToggle) {
            mobileMenuToggle.addEventListener('click', () => {
                adminSidebar.classList.add('active');
                sidebarOverlay.classList.add('active');
            });
        }

        // Cerrar barra lateral al hacer clic en superposici√≥n
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                adminSidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });
        }

        // Cerrar barra lateral al hacer clic en un enlace del men√∫ (m√≥vil)
        document.querySelectorAll('.admin-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    adminSidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                }
            });
        });


        async function loadDashboard() {
            // Obtener datos similar a app.js
            const token = localStorage.getItem('token');
            // Obtener Pedidos
            const res = await fetch(`${API_BASE}/orders.php`, { headers: { 'Authorization': token } });
            const data = await res.json();
            if (data.success) {
                renderOrders(data.orders);
                renderStats(data.orders);
            }


            // Obtener Productos
            const prodRes = await fetch(`${API_BASE}/products.php`);
            const prodData = await prodRes.json();
            if (prodData.success) {
                window.currentProducts = prodData.products;
                renderInventory(prodData.products);
                document.getElementById('statTotalProducts').textContent = prodData.products.length;
            }

            // Obtener Usuarios
            try {
                const uRes = await fetch(`${API_BASE}/api_admin.php?action=users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const uData = await uRes.json();
                if (uData.success) {
                    renderUsers(uData.users);
                    document.getElementById('statTotalUsers').textContent = uData.users.length;
                }
            } catch (e) { console.error("Error loading users", e); }

            // Obtener Servicios
            loadServices();

        }

        // --- L√ìGICA DE SERVICIOS ---
        function openAddService() {
            document.getElementById('addServiceModal').classList.add('active');
            document.getElementById('addServiceModal').classList.add('cart-modal--open');
        }
        function closeAddService() {
            const m = document.getElementById('addServiceModal');
            m.classList.remove('active');
            m.classList.remove('cart-modal--open');
            document.getElementById('addServiceForm').reset();
            document.getElementById('serviceImagePreviewGrid').innerHTML = '';
            serviceImagesBase64 = [];
        }

        let serviceImagesBase64 = [];
        async function handleServiceImagePreview(input) {
            const files = Array.from(input.files).slice(0, 5);
            const grid = document.getElementById('serviceImagePreviewGrid');
            grid.innerHTML = '';
            serviceImagesBase64 = [];
            for (const file of files) {
                const base64 = await toBase64(file);
                serviceImagesBase64.push(base64);
                const img = document.createElement('img');
                img.src = base64;
                img.style.width = '80px'; img.style.height = '80px';
                img.style.objectFit = 'cover'; img.style.borderRadius = '4px';
                grid.appendChild(img);
            }
        }

        async function submitService(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const payload = {
                user_id: formData.get('user_id'),
                bike: formData.get('bike'),
                type: formData.get('type'),
                description: formData.get('description'),
                status: formData.get('status'),
                cost: formData.get('cost'),
                images: serviceImagesBase64
            };

            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_BASE}/services.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.success) {
                    alert('Servicio registrado');
                    closeAddService();
                    loadServices();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (ex) { console.error(ex); alert('Error de conexi√≥n'); }
        }

        async function loadServices() {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_BASE}/services.php`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    renderServicesTB(data.services);
                }
            } catch (e) {
                console.error("Error loading services", e);
            }
        }

        function renderServicesTB(services) {
            const tbody = document.getElementById('servicesTableBody');
            if (!tbody) return;
            tbody.innerHTML = services.map(s => `
    <tr>
        <td>${s.id}</td>
        <td>${s.username} <br><small>${s.email}</small></td>
        <td>${s.bike_model}</td>
        <td>${s.service_type}</td>
        <td>
            <select onchange="updateServiceStatus(${s.id}, this.value)"
                style="padding:4px; border-radius:4px; border:1px solid #ddd; bg:${getStatusColor(s.status)}">
                <option value="recibido" ${s.status == 'recibido' ? 'selected' : ''}>Recibido</option>
                <option value="en_proceso" ${s.status == 'en_proceso' ? 'selected' : ''}>En Proceso</option>
                <option value="listo" ${s.status == 'listo' ? 'selected' : ''}>Listo</option>
                <option value="entregado" ${s.status == 'entregado' ? 'selected' : ''}>Entregado</option>
            </select>
        </td>
        <td>${new Date(s.entry_date).toLocaleDateString()}</td>
        <td><button onclick="alert('Ver detalles no implementado en admin a√∫n')">üëÅÔ∏è</button></td>
    </tr>
    `).join('');
        }

        async function updateServiceStatus(id, newStatus) {
            const token = localStorage.getItem('token');
            try {
                await fetch(`${API_BASE}/services.php`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ id: id, status: newStatus })
                });
                // alert('Estado actualizado');
            } catch (e) { alert('Error actualizando estado'); }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'listo': return '#d1fae5';
                case 'en_proceso': return '#dbeafe';
                case 'entregado': return '#f3f4f6';
                default: return '#fff';
            }
        }

        let salesChartInstance = null;

        function renderStats(orders) {
            const validOrders = orders.filter(o => o.status !== 'cancelled');
            const total = validOrders.reduce((acc, o) => acc + Number(o.total), 0);

            document.getElementById('statTotalSales').innerText = new Intl.NumberFormat('es-CO', {
                style: 'currency', currency: 'COP'
            }).format(total);

            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('statOrdersToday').innerText = orders.filter(o => o.created_at.startsWith(todayStr)).length;

            // Renderizar Gr√°fico
            renderSalesChart(validOrders);
        }

        function renderSalesChart(validOrders) {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;

            // Agrupar ventas por fecha
            const salesByDate = {};
            validOrders.forEach(o => {
                const date = o.created_at.split(' ')[0];
                if (!salesByDate[date]) salesByDate[date] = 0;
                salesByDate[date] += Number(o.total);
            });

            // Ordenar fechas
            const sortedDates = Object.keys(salesByDate).sort();
            const data = sortedDates.map(d => salesByDate[d]);

            if (salesChartInstance) salesChartInstance.destroy();

            salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Ventas Diarias (COP)',
                        data: data,
                        borderColor: '#D97706',
                        backgroundColor: 'rgba(217, 119, 6, 0.2)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#F59E0B'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { color: '#A8A29E' } }
                    },
                    scales: {
                        x: { ticks: { color: '#A8A29E' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { ticks: { color: '#A8A29E' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                    }
                }
            });
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('allOrdersTable');
            tbody.innerHTML = orders.map(o => `
    <tr>
        <td>${o.id}</td>
        <td>${o.reference || '-'}</td>
        <td>${o.user_name}</td>
        <td>${o.items.length}</td>
        <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(o.total)}</td>
        <td>${o.status}</td>
        <td><button>Ver</button></td>
    </tr>
    `).join('');

            // Recent
            document.getElementById('recentOrdersTable').innerHTML = orders.slice(0, 5).map(o => `
    <tr>
        <td>${o.reference}</td>
        <td>${o.user_name}</td>
        <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(o.total)}</td>
        <td>${o.status}</td>
        <td>${o.created_at}</td>
    </tr>
    `).join('');
        }


        function renderInventory(products) {
            document.getElementById('inventoryTable').innerHTML = products.map(p => `
    <tr>
        <td><img src="${p.image || (p.images && p.images[0]) || ''}" width="30" style="border-radius: 4px;"></td>
        <td>${p.name}</td>
        <td>${p.stock}</td>
        <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(p.price)}</td>
        <td><button class="btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" onclick="editProduct(${p.id})">‚úèÔ∏è</button></td>
    </tr>
    `).join('');
        }

        function exportInventoryToExcel() {
            if (!window.currentProducts || window.currentProducts.length === 0) {
                alert("El inventario est√° vac√≠o.");
                return;
            }

            const dataForExcel = window.currentProducts.map(p => ({
                "ID": p.id,
                "Nombre": p.name,
                "Marca": p.brand || "-",
                "Categor√≠a": p.category,
                "Referencia / Modelo": p.use || "-",
                "Stock": p.stock,
                "Precio (COP)": p.price,
                "Estado": p.tag || "-",
                "C√≥digo Barras": p.barcode || ""
            }));

            const ws = XLSX.utils.json_to_sheet(dataForExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario");
            XLSX.writeFile(wb, "Inventario_ElPedalazo.xlsx");
        }

        function editProduct(id) {
            const product = window.currentProducts.find(p => p.id == id);
            if (!product) return;

            document.getElementById('editProductId').value = product.id;

            // Llenar campos
            const form = document.getElementById('addProductForm');
            form.elements['name'].value = product.name;
            form.elements['price'].value = product.price;
            form.elements['stock'].value = product.stock;
            form.elements['barcode'].value = product.barcode || '';
            document.getElementById('input-tag').value = product.tag || '';

            // Marcas y categor√≠as
            setFinalValue('brand', product.brand);
            toggleHybrid('brand', 'input');
            document.getElementById('brandInput').value = product.brand;

            setFinalValue('category', product.category);
            toggleHybrid('category', 'input');
            document.getElementById('categoryInput').value = product.category;

            // Tipo y uso
            const useField = product.use || product.use_type || '';
            document.getElementById('final-use').value = useField;
            document.getElementById('input-use').value = useField;

            openAddProduct();
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            tbody.innerHTML = users.map(u => `
    <tr>
        <td>${u.id}</td>
        <td>${u.username}</td>
        <td>${u.email}</td>
        <td>${u.phone || '-'}</td>
        <td>
            <select onchange="changeRole(${u.id}, this.value)"
                style="padding:0.2rem; border-radius:4px; border:1px solid #ccc;">
                <option value="0" ${u.isAdmin == 0 ? 'selected' : ''}>Usuario</option>
                <option value="1" ${u.isAdmin == 1 ? 'selected' : ''}>Admin</option>
            </select>
        </td>
    </tr>
    `).join('');
        }

        async function changeRole(id, val) {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_BASE}/update_role.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ id: id, isAdmin: val })
                });
                const data = await res.json();
                alert(data.message);
                // Recargar dashboard para reflejar cambios si es necesario
            } catch (e) {
                console.error(e);
                alert("Error al actualizar rol");
            }
        }

        checkAdmin();
    </script>
</body>

</html>
<script>
    // Logic for Bike vs Car Product Type
    const carData = {
        'Chevrolet': ['Spark GT', 'Spark Life', 'Sail', 'Onix', 'Tracker', 'Captiva', 'N300', 'Beat', 'Optra', 'Aveo'],
        'Renault': ['Logan', 'Sandero', 'Stepway', 'Duster', 'Kwid', 'Clio', 'Captur', 'Kangoo', 'Master'],
        'Kia': ['Picanto Ion', 'Picanto GT Line', 'Rio Spice', 'Rio R', 'Sportage Revolution', 'Sportage QL', 'Cerato', 'Soluto'],
        'Mazda': ['Mazda 2', 'Mazda 3', 'CX-30', 'CX-5', 'BT-50', 'Mazda 6'],
        'Nissan': ['March', 'Versa', 'Kicks', 'Frontier', 'Qashqai', 'Sentra'],
        'Toyota': ['Hilux', 'Fortuner', 'Corolla', 'Prado', 'TXL', 'Yaris'],
        'Hyundai': ['Grand i10', 'Accent', 'Tucson', 'Getz', 'i25', 'Creta'],
        'Suzuki': ['Swift', 'Vitara', 'Jimny', 'Alto'],
        'Volkswagen': ['Gol', 'Voyage', 'Jetta', 'Amarok'],
        'Ford': ['Fiesta', 'Ecosport', 'Escape', 'Ranger'],
        'Taxis': ['Zapatico (Atos)', 'Grand i10', 'Picanto Taxi', 'Kia Rio Taxi', 'Cronos']
    };

    const carParts = [
        'Automotriz - Motor',
        'Automotriz - Suspensi√≥n',
        'Automotriz - Frenos',
        'Automotriz - El√©ctrico',
        'Automotriz - Carrocer√≠a',
        'Automotriz - Refrigeraci√≥n',
        'Automotriz - Filtros y Aceites',
        'Automotriz - Transmisi√≥n',
        'Automotriz - Lujos y Accesorios',
        'Automotriz - Llantas'
    ];

    let currentProductType = 'bike';

    function toggleProductType(type) {
        currentProductType = type;
        const brandSel = document.getElementById('brandSelect');
        const catSel = document.getElementById('categorySelect');
        const useInput = document.getElementById('input-use');
        const useSelect = document.getElementById('select-use');
        const useLabel = document.getElementById('lbl-use');

        // Reset values
        document.getElementById('addProductForm').reset();

        // Re-check the radio button because reset() clears it back to default
        // We need to manually set the radio back to 'type'
        document.querySelector(`input[name="productType"][value="${type}"]`).checked = true;

        if (type === 'car') {
            // Car Mode
            useLabel.innerText = "Modelo del Carro (Referencia)";
            useInput.style.display = 'none';
            useSelect.style.display = 'block';

            // Populate Car Brands
            brandSel.innerHTML = '<option value="">Selecciona Marca de Carro...</option>';
            Object.keys(carData).forEach(brand => {
                brandSel.innerHTML += `<option value="${brand}">${brand}</option>`;
            });

            // Populate Car Parts Categories
            catSel.innerHTML = '<option value="">Selecciona Tipo de Repuesto...</option>';
            carParts.forEach(part => {
                // Remove 'Automotriz - ' prefix for display if desired, or keep it
                const display = part.replace('Automotriz - ', '');
                catSel.innerHTML += `<option value="${part}">${display}</option>`;
            });

        } else {
            // Bike Mode (Restore original logic/data)
            useLabel.innerText = "Uso (Ej: Monta√±a, Ruta)";
            useInput.style.display = 'block';
            useSelect.style.display = 'none';

            // Reload default metadata (will require re-fetching or reloading page logic)
            // Since we don't want to reload page, we can manually populate standard bike brands/cats
            // Or just trigger the original load function if available.
            // Simple workaround: reload page-like behavior or just re-populate defaults
            loadProductMetadata();
        }
    }

    // Hook into Brand Change to populate Models
    document.getElementById('brandSelect').addEventListener('change', function () {
        if (currentProductType === 'car') {
            const brand = this.value;
            const useSelect = document.getElementById('select-use');
            useSelect.innerHTML = '<option value="">Selecciona Referencia...</option>';

            if (carData[brand]) {
                carData[brand].forEach(model => {
                    useSelect.innerHTML += `<option value="${model}">${model}</option>`;
                });
            }
        }
    });

    // Initial Load Fix
    // Ensure 'use-input' value goes to 'final-use' on load
    document.getElementById('input-use').addEventListener('input', function () {
        document.getElementById('final-use').value = this.value;
    });

</script>