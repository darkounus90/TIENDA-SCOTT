<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - El Pedalazo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css?v=4.5.0">
    <style>
        /* Specific overrides for standalone admin page */
        body {
            margin: 0;
            padding: 0;
            background: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }

        .admin-dashboard-container {
            display: grid;
            grid-template-columns: 260px 1fr;
            height: 100vh;
            width: 100vw;
        }

        .admin-main {
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .admin-content-area {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }
    </style>
</head>

<body>

    <div class="admin-dashboard-container" id="adminApp" style="display:none;">
        <!-- Sidebar -->
        <aside class="admin-sidebar" style="height: 100vh;">
            <div class="admin-sidebar-header">
                <h2>üöÄ SCOTT Admin</h2>
            </div>
            <nav class="admin-nav">
                <button class="admin-tab-btn active" data-tab="tab-overview">
                    <span class="icon">üìä</span> <span>Resumen</span>
                </button>
                <button class="admin-tab-btn" data-tab="tab-orders">
                    <span class="icon">üõçÔ∏è</span> <span>Ventas</span>
                </button>
                <button class="admin-tab-btn" data-tab="tab-inventory">
                    <span class="icon">üö≤</span> <span>Inventario</span>
                </button>
                <button class="admin-tab-btn" data-tab="tab-users">
                    <span class="icon">üë•</span> <span>Usuarios</span>
                </button>
                <button class="admin-tab-btn" id="adminLogout">
                    <span class="icon">üö™</span> <span>Salir</span>
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-topbar">
                <h3>Panel de Control</h3>
                <div style="display:flex; gap:1rem; align-items:center;">
                    <span id="adminUsername" style="font-weight:600; color:#475569;">Admin</span>
                    <a href="/" class="btn-secondary" style="text-decoration:none; padding: 0.5rem 1rem;">Ir a
                        Tienda</a>
                </div>
            </div>

            <div class="admin-content-area">
                <!-- Tab: Overview -->
                <div id="tab-overview" class="view-section active">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üí∞</div>
                            <div class="stat-info">
                                <h4>Ventas Totales</h4>
                                <p id="statTotalSales">$0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üì¶</div>
                            <div class="stat-info">
                                <h4>Pedidos Hoy</h4>
                                <p id="statOrdersToday">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üö≤</div>
                            <div class="stat-info">
                                <h4>Productos</h4>
                                <p id="statTotalProducts">0</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-info">
                                <h4>Usuarios</h4>
                                <p id="statTotalUsers">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="table-card">
                        <div class="table-header">
                            <h3>√öltimos Pedidos</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Usuario</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody id="recentOrdersTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Orders -->
                <div id="tab-orders" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Historial de Ventas</h3>
                            <input type="text" placeholder="Buscar..."
                                style="padding:0.5rem; border-radius:8px; border:1px solid #cbd5e1;">
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Referencia</th>
                                    <th>Cliente</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="allOrdersTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Inventory -->
                <div id="tab-inventory" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Inventario</h3>
                            <button class="btn-primary" onclick="openAddProduct()">+ Producto</button>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Img</th>
                                    <th>Producto</th>
                                    <th>Stock</th>
                                    <th>Precio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Users -->

                <div id="tab-users" class="view-section">
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Usuarios Registrados</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Usuario</th>
                                    <th>Email</th>
                                    <th>Tel√©fono</th>
                                    <th>Rol</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modal Add Product Full -->
    <div class="cart-modal" id="addProductModal" onclick="closeAddProduct()">
        <div class="cart-modal__content add-product-modal" onclick="event.stopPropagation()">
            <button class="cart-modal__close" onclick="closeAddProduct()">‚úï</button>
            <h2>Agregar Nuevo Producto</h2>
            <form id="addProductForm" class="product-form" onsubmit="submitProduct(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre del Producto</label>
                        <input type="text" name="name" required class="form-input" placeholder="Ej: Scott Spark RC">
                    </div>
                    <div class="form-group">
                        <label>Marca</label>
                        <input type="text" name="brand" required class="form-input" placeholder="Ej: Scott">
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <select name="category" required class="form-input">
                            <option value="bicicletas">Bicicletas</option>
                            <option value="accesorios">Accesorios</option>
                            <option value="repuestos">Repuestos</option>
                            <option value="ropa">Ropa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Precio</label>
                        <input type="number" name="price" required class="form-input" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Stock</label>
                        <input type="number" name="stock" required class="form-input" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>Uso</label>
                        <input type="text" name="use" required class="form-input" placeholder="Ej: Monta√±a, Ruta">
                    </div>
                    <div class="form-group">
                        <label>Etiqueta</label>
                        <input type="text" name="tag" class="form-input" placeholder="Ej: Nuevo">
                    </div>
                    <div class="form-group">
                        <label>C√≥digo de Barras</label>
                        <input type="text" name="barcode" class="form-input" placeholder="Opcional">
                    </div>
                </div>

                <div class="form-group full-width" style="margin-top: 1.5rem;">
                    <label>Im√°genes del Producto</label>
                    <div class="file-upload-wrapper">
                        <input type="file" id="productImages" multiple accept="image/*"
                            onchange="handleImagePreview(this)" class="file-input">
                        <div class="file-cta">
                            <span class="icon">üì∑</span>
                            <span>Seleccionar im√°genes (M√°x 3)</span>
                        </div>
                    </div>
                    <div id="imagePreviewGrid" class="image-preview-grid"></div>
                </div> <!-- Cierre form-group full-width -->
        </div> <!-- Cierre form-grid -->

        <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="closeAddProduct()">Cancelar</button>
            <button type="submit" class="btn-primary">Guardar Producto</button>
        </div>
        </form>
    </div>
    </div>

    <script>
        // ADMIN LOGIC ISOLATED
        const API_BASE = 'api';

        // --- Product Management ---
        function openAddProduct() {
            const modal = document.getElementById('addProductModal');
            modal.classList.add('active');
            modal.classList.add('cart-modal--open'); // Asegurar consistencia con CSS
        }

        function closeAddProduct() {
            const modal = document.getElementById('addProductModal');
            modal.classList.remove('active');
            modal.classList.remove('cart-modal--open');
            document.getElementById('addProductForm').reset();
            document.getElementById('imagePreviewGrid').innerHTML = '';
            productImagesBase64 = [];
        }

        let productImagesBase64 = [];

        async function handleImagePreview(input) {
            const files = Array.from(input.files).slice(0, 3);
            const grid = document.getElementById('imagePreviewGrid');
            grid.innerHTML = '';
            productImagesBase64 = [];

            for (const file of files) {
                const base64 = await toBase64(file);
                productImagesBase64.push(base64);

                const img = document.createElement('img');
                img.src = base64;
                img.style.width = '80px';
                img.style.height = '80px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '4px';
                grid.appendChild(img);
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function submitProduct(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            const payload = {
                name: formData.get('name'),
                brand: formData.get('brand'),
                category: formData.get('category'),
                price: parseFloat(formData.get('price')),
                stock: parseInt(formData.get('stock')),
                use: formData.get('use'),
                tag: formData.get('tag'),
                barcode: formData.get('barcode'),
                images: productImagesBase64
            };

            const token = localStorage.getItem('token');

            try {
                const res = await fetch(`${API_BASE}/products.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (data.success) {
                    alert('Producto creado exitosamente');
                    closeAddProduct();
                    loadDashboard(); // Recargar inventario
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (err) {
                console.error(err);
                alert('Error de conexi√≥n');
            }
        }

        async function checkAdmin() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert("No hay token de sesi√≥n. Inicia sesi√≥n nuevamente.");
                window.location.href = 'index.html';
                return;
            }

            try {
                // Check against API with Bearer prefix AND query param backup + Cache Buster
                const res = await fetch(`${API_BASE}/me.php?token=${encodeURIComponent(token)}&_t=${Date.now()}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    throw new Error(`Error del servidor (${res.status}). Intenta recargar.`);
                }

                const data = await res.json();

                if (data.success && data.user.isAdmin) {
                    document.getElementById('adminApp').style.display = 'grid';
                    document.getElementById('adminUsername').textContent = data.user.username;
                    loadDashboard();
                } else {
                    // Solo redirigir si la API dice expl√≠citamente que no es v√°lido
                    console.warn("Acceso denegado:", data);
                    alert("Tu sesi√≥n ha expirado o no tienes permisos. Por favor ingresa nuevamente.");
                    localStorage.removeItem('token'); // Limpiar token inv√°lido
                    window.location.href = 'index.html';
                }
            } catch (e) {
                console.error("Admin check error:", e);
                // Si es error de conexi√≥n o parseo, NO redirigir autom√°ticamente, dar opci√≥n al usuario
                const retry = confirm("Error de conexi√≥n con el servidor:\n" + e.message + "\n\n¬øDeseas reintentar?");
                if (retry) {
                    location.reload();
                } else {
                    // Opcional: Ir al inicio si el usuario desiste
                    // window.location.href = 'index.html';
                }
            }
        }

        document.getElementById('adminLogout').addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/';
        });

        // Tab Logic
        document.querySelectorAll('.admin-tab-btn[data-tab]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        async function loadDashboard() {
            // Fetch data similar to app.js
            const token = localStorage.getItem('token');
            // Fetch Orders
            const res = await fetch(`${API_BASE}/orders.php`, { headers: { 'Authorization': token } });
            const data = await res.json();
            if (data.success) {
                renderOrders(data.orders);
                renderStats(data.orders);
            }


            // Fetch Products
            const prodRes = await fetch(`${API_BASE}/products.php`);
            const products = await prodRes.json();
            renderInventory(products);
            document.getElementById('statTotalProducts').textContent = products.length;

            // Fetch Users
            try {
                const userRes = await fetch(`${API_BASE}/users.php`, { headers: { 'Authorization': `Bearer ${token}` } });
                const users = await userRes.json();
                if (Array.isArray(users)) {
                    renderUsers(users);
                    document.getElementById('statTotalUsers').textContent = users.length;
                }
            } catch (e) { console.error("Error loading users", e); }

        }

        function renderStats(orders) {
            const total = orders.filter(o => o.status !== 'cancelled').reduce((acc, o) => acc + Number(o.total), 0);
            document.getElementById('statTotalSales').innerText = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(total);
            document.getElementById('statOrdersToday').innerText = orders.filter(o => o.created_at.startsWith(new Date().toISOString().split('T')[0])).length;
        }

        function renderOrders(orders) {
            const tbody = document.getElementById('allOrdersTable');
            tbody.innerHTML = orders.map(o => `
        <tr>
            <td>${o.id}</td>
            <td>${o.reference || '-'}</td>
            <td>${o.user_name}</td>
            <td>${o.items.length}</td>
            <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(o.total)}</td>
            <td>${o.status}</td>
            <td><button>Ver</button></td>
        </tr>
    `).join('');

            // Recent
            document.getElementById('recentOrdersTable').innerHTML = orders.slice(0, 5).map(o => `
        <tr>
            <td>${o.reference}</td>
            <td>${o.user_name}</td>
            <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(o.total)}</td>
            <td>${o.status}</td>
            <td>${o.created_at}</td>
        </tr>
    `).join('');
        }


        function renderInventory(products) {
            document.getElementById('inventoryTable').innerHTML = products.map(p => `
        <tr>
            <td><img src="${p.image || p.images[0]}" width="30"></td>
            <td>${p.name}</td>
            <td>${p.stock}</td>
            <td>${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(p.price)}</td>
            <td><button>‚úèÔ∏è</button></td>
        </tr>
    `).join('');
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            tbody.innerHTML = users.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.username}</td>
                    <td>${u.email}</td>
                    <td>${u.phone || '-'}</td>
                    <td>
                        <select onchange="changeRole(${u.id}, this.value)" style="padding:0.2rem; border-radius:4px; border:1px solid #ccc;">
                            <option value="0" ${u.isAdmin == 0 ? 'selected' : ''}>Usuario</option>
                            <option value="1" ${u.isAdmin == 1 ? 'selected' : ''}>Admin</option>
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        async function changeRole(id, val) {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_BASE}/update_role.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ id: id, isAdmin: val })
                });
                const data = await res.json();
                alert(data.message);
                // Reload dashboard to reflect changes if necessary
            } catch (e) {
                console.error(e);
                alert("Error al actualizar rol");
            }
        }

        checkAdmin();
    </script>
</body>

</html>